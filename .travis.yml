sudo: required
language: node_js
node_js: '8'
git:
  depth: 1
cache:
  yarn: true
  directories:
# All directories need to be listed here, because Travis does not support globs.
# Auto generated by scripts/prepare-travis
# start_cache_directories
  - dev-packages/application-manager/node_modules
  - dev-packages/application-package/node_modules
  - examples/browser/node_modules
  - examples/electron/node_modules
  - node_modules
  - packages/bunyan/node_modules
  - packages/callhierarchy/node_modules
  - packages/console/node_modules
  - packages/core/node_modules
  - packages/cpp/node_modules
  - packages/debug-nodejs/node_modules
  - packages/debug/node_modules
  - packages/editor-preview/node_modules
  - packages/editor/node_modules
  - packages/editorconfig/node_modules
  - packages/extension-manager/node_modules
  - packages/file-search/node_modules
  - packages/filesystem/node_modules
  - packages/getting-started/node_modules
  - packages/git/node_modules
  - packages/java-debug/node_modules
  - packages/java/node_modules
  - packages/json/node_modules
  - packages/keymaps/node_modules
  - packages/languages/node_modules
  - packages/markers/node_modules
  - packages/merge-conflicts/node_modules
  - packages/messages/node_modules
  - packages/metrics/node_modules
  - packages/mini-browser/node_modules
  - packages/monaco/node_modules
  - packages/navigator/node_modules
  - packages/outline-view/node_modules
  - packages/output/node_modules
  - packages/plugin-ext-vscode/node_modules
  - packages/plugin-ext/node_modules
  - packages/plugin/node_modules
  - packages/preferences/node_modules
  - packages/preview/node_modules
  - packages/process/node_modules
  - packages/python/node_modules
  - packages/search-in-workspace/node_modules
  - packages/task/node_modules
  - packages/terminal/node_modules
  - packages/textmate-grammars/node_modules
  - packages/tslint/node_modules
  - packages/typescript/node_modules
  - packages/userstorage/node_modules
  - packages/variable-resolver/node_modules
  - packages/vue/node_modules
  - packages/workspace/node_modules
# end_cache_directories
  - packages/java-debug/download
  - packages/debug-nodejs/download
branches:
  only:
  - master
env:
  global:
    - CXX=g++-4.8
    - NODE_OPTIONS="--max_old_space_size=4096"
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    - oracle-java9-set-default
    - libsecret-1-dev
    chrome: stable
before_script:
  - export DISPLAY=:99.0; sh -e /etc/init.d/xvfb start ;
  - google-chrome-stable --headless --disable-gpu --remote-debugging-port=9222 http://localhost \&  ;
before_install:
  - curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.13.0
  - export PATH=$HOME/.yarn/bin:$PATH ;
install: yarn && scripts/check_git_status.sh
script:
  # Unset the `protocol.version` in the `global` Git configuration. See: https://github.com/theia-ide/theia/issues/4371
  - git config --global --unset protocol.version
  - travis_retry yarn test:theia ;
  - travis_retry yarn test:electron ;
  - travis_retry yarn test:browser ;
notifications:
  webhooks:
    urls:
    - https://webhooks.gitter.im/e/c42ddc125fe6bbfccb48
    on_success: change
    on_failure: always
    on_start: never
jobs:
  fast_finish: true
  allow_failures:
    - os: osx
  include:
  - stage: test
    os: linux
  - os: osx
    env: CXX=c++
    before_script: skip
    script: travis_retry yarn test:theia ;
  - stage: deploy
    if: NOT type IN (cron, pull_request)
    os: linux
    before_script: skip
    script: skip
    install: skip
    before_deploy:
      - printf "//registry.npmjs.org/:_authToken=${NPM_AUTH_TOKEN}\n" >> ~/.npmrc
      - yarn
    deploy:
      provider: script
      script: yarn run publish:next
      on:
        branch: master
      skip_cleanup: true
